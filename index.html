<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dani TV - Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>

    <header>
        <img src="logo.png" alt="Dani TV Logo" class="logo">
        <h1>Dani TV</h1>
        <button id="settings-btn" title="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">âš™ï¸</button>
    </header>

    <div id="settings-panel" class="settings-panel" style="display: none;">
        <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø¯Ù… Xtream</h3>
        <label for="host-input">Host (URL:Port)</label>
        <input type="text" id="host-input" placeholder="http://example.com:8080">
        <label for="user-input">Username</label>
        <input type="text" id="user-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <label for="pass-input">Password</label>
        <input type="text" id="pass-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button id="update-m3u-btn">ØªØ­Ø¯ÙŠØ« ÙˆØ­ÙØ¸</button>
        <button id="clear-m3u-btn">Ù…Ø³Ø­ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ù„ÙŠ</button>
    </div>

    <nav class="tabs-nav">
        <button id="tab-livetv" class="tab-btn active" onclick="showView('live-tv-view')">ğŸ“º Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</button>
        <button id="tab-codes" class="tab-btn" onclick="showView('codes-view')">ğŸ”‘ Ø£ÙƒÙˆØ§Ø¯ Ù…Ø¬Ø§Ù†ÙŠØ©</button>
    </nav>

    <div id="live-tv-view" class="view-container active-view">
        <div class="container">
            <div class="list-container" id="category-container">
                <h2>Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</h2>
                <ul id="category-list">
                    <li class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª...</li>
                </ul>
            </div>
            <div class="list-container" id="channel-list-container">
                <h2 id="channel-list-title">Ø§Ù„Ù‚Ù†ÙˆØ§Øª</h2>
                <input type="text" id="search-bar" onkeyup="filterChannels()" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ...">
                <ul id="channel-list">
                    <li class="loading">Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹...</li>
                </ul>
            </div>
            <div class="player-container">
                <h2 id="channel-title">Ø§Ø®ØªØ± Ù‚Ù†Ø§Ø© Ù„ØªØ¨Ø¯Ø£</h2>
                <video id="videoPlayer" autoplay muted></video>
            </div>
        </div>
    </div>

    <div id="codes-view" class="view-container" style="display: none;">
        <div class="codes-container">
            <h2>Ø£ÙƒÙˆØ§Ø¯ Xtream (Ù„Ù„ØªØ¬Ø±Ø¨Ø©)</h2>
            <p>Ø§Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ£Ø¯Ø®Ù„Ù‡Ø§ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (âš™ï¸) ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰.</p>
            <div id="codes-list">
                </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('videoPlayer');
        let hls; 
        let categoriesData = {}; 
        let activeCategoryElement = null; 
        let activeChannelElement = null; 
        
        const player = new Plyr(video, {
            captions: { active: false, language: 'auto', update: false },
            autoplay: true,
            muted: true,
        });

        if (Hls.isSupported()) {
            hls = new Hls();
            hls.attachMedia(video);
        }
        
        const CORS_PROXY = "https://api.allorigins.win/raw?url=";

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ---
        function showView(viewId) {
            document.getElementById('live-tv-view').style.display = 'none';
            document.getElementById('codes-view').style.display = 'none';
            document.getElementById('tab-livetv').classList.remove('active');
            document.getElementById('tab-codes').classList.remove('active');
            document.getElementById(viewId).style.display = 'block';
            const activeTabBtn = (viewId === 'live-tv-view') ? 'tab-livetv' : 'tab-codes';
            document.getElementById(activeTabBtn).classList.add('active');
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ ---
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert("ØªÙ… Ù†Ø³Ø®: " + text);
            }, (err) => {
                alert("ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®.");
            });
        }

        // --- ÙˆØ¸ÙŠÙØ© Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ---
        async function loadFreeCodes() {
            try {
                const response = await fetch('codes.json');
                if (!response.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø£ÙƒÙˆØ§Ø¯');
                const codes = await response.json();
                
                const codesListDiv = document.getElementById('codes-list');
                codesListDiv.innerHTML = ''; 
                
                codes.forEach(code => {
                    const card = document.createElement('div');
                    card.className = 'code-card';
                    // (Ù…Ù‡Ù…) Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù†Øµ ÙŠØ¸Ù‡Ø± LTR Ù„Ù„Ø£ÙƒÙˆØ§Ø¯
                    card.innerHTML = `
                        <div class="code-field">
                            <label>Host:</label>
                            <input type="text" value="${code.host}" readonly style="direction: ltr;">
                            <button onclick="copyToClipboard('${code.host}')">Ù†Ø³Ø®</button>
                        </div>
                        <div class="code-field">
                            <label>User:</label>
                            <input type="text" value="${code.user}" readonly style="direction: ltr;">
                            <button onclick="copyToClipboard('${code.user}')">Ù†Ø³Ø®</button>
                        </div>
                        <div class="code-field">
                            <label>Pass:</label>
                            <input type="text" value="${code.pass}" readonly style="direction: ltr;">
                            <button onclick="copyToClipboard('${code.pass}')">Ù†Ø³Ø®</button>
                        </div>
                        <p class="code-note">Ù…Ù„Ø§Ø­Ø¸Ø©: ${code.note}</p>
                    `;
                    codesListDiv.appendChild(card);
                });

            } catch (error) {
                console.error(error);
                document.getElementById('codes-list').innerHTML = `<p class="loading error">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯: ${error.message}</p>`;
            }
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
        const settingsBtn = document.getElementById('settings-btn');
        const settingsPanel = document.getElementById('settings-panel');
        const updateBtn = document.getElementById('update-m3u-btn');
        const clearBtn = document.getElementById('clear-m3u-btn');
        const hostInput = document.getElementById('host-input');
        const userInput = document.getElementById('user-input');
        const passInput = document.getElementById('pass-input');

        settingsBtn.onclick = () => {
            settingsPanel.style.display = (settingsPanel.style.display === 'none') ? 'block' : 'none';
        };
        updateBtn.onclick = () => {
            const host = hostInput.value.trim();
            const user = userInput.value.trim();
            const pass = passInput.value.trim();
            if (host && user && pass) {
                localStorage.setItem('xtream_host', host);
                localStorage.setItem('xtream_user', user);
                localStorage.setItem('xtream_pass', pass);
                alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª! Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª.');
                location.reload(); 
            } else {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø«Ù„Ø§Ø«Ø© (Host, Username, Password).');
            }
        };
        clearBtn.onclick = () => {
            localStorage.removeItem('xtream_host');
            localStorage.removeItem('xtream_user');
            localStorage.removeItem('xtream_pass');
            alert('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø³ÙŠØ¹ÙˆØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù„Ù channels.m3u Ø§Ù„Ù…Ø­Ù„ÙŠ.');
            location.reload();
        };

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ---
        function playChannel(name, url, clickedElement) {
            document.getElementById('channel-title').innerText = `Ø£Ù†Øª ØªØ´Ø§Ù‡Ø¯ Ø§Ù„Ø¢Ù†: ${name}`;
            if (activeChannelElement) activeChannelElement.classList.remove('active');
            clickedElement.classList.add('active');
            activeChannelElement = clickedElement;
            if (Hls.isSupported() && hls) {
                hls.loadSource(url);
                hls.on(Hls.Events.MEDIA_ATTACHED, () => player.play()); 
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
                video.addEventListener('loadedmetadata', () => player.play()); 
            }
            if (window.innerWidth < 900) {
                document.getElementById('player-container').scrollIntoView({ behavior: 'smooth' });
            }
        }
        async function parseM3U(m3uText) {
            try {
                const lines = m3uText.split('\n');
                const categories = { "Ù…ØªÙØ±Ù‚Ø§Øª": [] }; 
                let currentTitle = null;
                let currentGroup = "Ù…ØªÙØ±Ù‚Ø§Øª"; 
                for (const line of lines) {
                    if (line.startsWith('#EXTINF:')) {
                        const groupMatch = line.match(/group-title="([^"]+)"/);
                        currentGroup = (groupMatch && groupMatch[1]) ? groupMatch[1].trim() : "Ù…ØªÙØ±Ù‚Ø§Øª";
                        const nameMatch = line.match(/tvg-name="([^"]+)"/);
                        currentTitle = (nameMatch && nameMatch[1]) ? nameMatch[1].trim() : line.split(',').pop().trim();
                        if (!categories[currentGroup]) {
                            categories[currentGroup] = [];
                        }
                    } else if (line.startsWith('http') && currentTitle) {
                        categories[currentGroup].push({ name: currentTitle, url: line.trim() });
                        currentTitle = null; 
                    }
                }
                return categories;
            } catch (error) { return { "Ø®Ø·Ø£": [] }; }
        }
        function filterChannels() {
            const input = document.getElementById('search-bar');
            const filter = input.value.toUpperCase(); 
            const ul = document.getElementById('channel-list');
            const li = ul.getElementsByTagName('li');
            for (let i = 0; i < li.length; i++) {
                const txtValue = li[i].textContent || li[i].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) li[i].style.display = "";
                else li[i].style.display = "none";
            }
        }
        function displayChannels(categoryName, clickedElement) {
            const channelList = document.getElementById('channel-list');
            const channels = categoriesData[categoryName] || [];
            channelList.innerHTML = ''; 
            document.getElementById('channel-list-title').innerText = categoryName;
            if (activeCategoryElement) activeCategoryElement.classList.remove('active');
            clickedElement.classList.add('active');
            activeCategoryElement = clickedElement;
            if (activeChannelElement) {
                activeChannelElement.classList.remove('active');
                activeChannelElement = null;
            }
            if (channels.length > 0) {
                channels.forEach(channel => {
                    const li = document.createElement('li');
                    li.innerText = channel.name;
                    li.onclick = () => playChannel(channel.name, channel.url, li);
                    channelList.appendChild(li);
                });
            } else {
                channelList.innerHTML = '<li class="loading">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù†ÙˆØ§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ.</li>';
            }
        }
        function renderCategories(categories) {
            const categoryList = document.getElementById('category-list');
            const categoryNames = Object.keys(categories);
            if (categoryNames.length > 0 && categoryNames[0] !== "Ø®Ø·Ø£") {
                categoryList.innerHTML = ''; 
                const sortedCategories = categoryNames.sort((a, b) => {
                    if (a.toLowerCase().includes('bein')) return -1;
                    if (b.toLowerCase().includes('bein')) return 1;
                    return 0;
                });
                sortedCategories.forEach(name => {
                    const li = document.createElement('li');
                    li.innerText = name;
                    li.onclick = () => displayChannels(name, li);
                    categoryList.appendChild(li);
                });
                if(categoryList.firstChild){
                    displayChannels(sortedCategories[0], categoryList.firstChild);
                    categoryList.firstChild.classList.add('active'); 
                    activeCategoryElement = categoryList.firstChild;
                }
            } else {
                throw new Error("ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª");
            }
        }

        // (Ù…Ø­Ø¯Ø«) Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ø§Ø¨Ø¯Ø£ Ø¨ÙƒÙ„ Ø´ÙŠØ¡
        document.addEventListener('DOMContentLoaded', async () => {
            const categoryList = document.getElementById('category-list');
            const channelList = document.getElementById('channel-list');
            
            const savedHost = localStorage.getItem('xtream_host');
            const savedUser = localStorage.getItem('xtream_user');
            const savedPass = localStorage.getItem('xtream_pass');
            
            if (savedHost) hostInput.value = savedHost;
            if (savedUser) userInput.value = savedUser;
            if (savedPass) passInput.value = savedPass;

            // (Ø¬Ø¯ÙŠØ¯) ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
            loadFreeCodes();

            try {
                let m3uText;
                if (savedHost && savedUser && savedPass) {
                    let fullUrl = `${savedHost}/get.php?username=${savedUser}&password=${savedPass}&type=m3u_plus&output=ts`;
                    const response = await fetch(`${CORS_PROXY}${encodeURIComponent(fullUrl)}`);
                    if (!response.ok) throw new Error('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ');
                    m3uText = await response.text();
                } else {
                    const response = await fetch('channels.m3u');
                    if (!response.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ù„ÙŠ channels.m3u');
                    m3uText = await response.text();
                }
                categoriesData = await parseM3U(m3uText);
                renderCategories(categoriesData);
            } catch (error) {
                console.error(error);
                categoryList.innerHTML = `<li class="loading error">${error.message}</li>`;
                channelList.innerHTML = `<li class="loading error">ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ø¯Ù… ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ùˆ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ù„ÙŠ.</li>`;
            }
        });
    </script>

</body>
</html>