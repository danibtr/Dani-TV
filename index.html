<script>
        // إعداد مشغل HLS.js
        const video = document.getElementById('videoPlayer');
        let hls; 

        if (Hls.isSupported()) {
            hls = new Hls();
            hls.attachMedia(video);
        } else {
            console.warn("HLS.js غير مدعوم أو فشل في التحميل. سنعتمد على المتصفح.");
        }

        // وظيفة لتشغيل قناة معينة
        function playChannel(name, url, clickedElement) {
            document.getElementById('channel-title').innerText = `أنت تشاهد الآن: ${name}`;
            
            // إزالة التمييز (class 'active') من جميع القنوات
            const allChannels = document.querySelectorAll('#channel-list li');
            allChannels.forEach(item => item.classList.remove('active'));
            
            // إضافة التمييز (class 'active') للقناة التي تم النقر عليها
            if (clickedElement) {
                clickedElement.classList.add('active');
            }

            // التحقق مرة أخرى قبل التشغيل
            if (Hls.isSupported() && hls) {
                hls.loadSource(url);
                hls.on(Hls.Events.MEDIA_ATTACHED, function () {
                    video.play();
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
                video.addEventListener('loadedmetadata', function () {
                    video.play();
                });
            } else {
                document.getElementById('channel-title').innerText = "خطأ: لا يمكن تشغيل هذا البث";
            }
            
            window.scrollTo(0, 0);
        }

        // وظيفة لتحليل ملف m3u
        async function parseM3U(fileUrl) {
            try {
                // التأكد من أن المتصفح يطلب الملف بالتشفير الصحيح
                const response = await fetch(encodeURI(fileUrl)); 
                if (!response.ok) { 
                    throw new Error('فشل تحميل الملف - 404');
                }
                const text = await response.text();
                const lines = text.split('\n');
                
                const channels = [];
                let currentTitle = null;

                for (const line of lines) {
                    if (line.startsWith('#EXTINF:')) {
                        const nameMatch = line.match(/tvg-name="([^"]+)"/);
                        if (nameMatch && nameMatch[1]) {
                            currentTitle = nameMatch[1];
                        } else {
                            currentTitle = line.split(',').pop();
                        }
                    } else if (line.startsWith('http') && currentTitle) {
                        channels.push({ name: currentTitle.trim(), url: line.trim() });
                        currentTitle = null; 
                    }
                }
                return channels;
            } catch (error) {
                console.error('خطأ في جلب ملف القنوات:', error);
                return [];
            }
        }

        // وظيفة لفلترة (بحث) القنوات (كما هي)
        function filterChannels() {
            const input = document.getElementById('search-bar');
            const filter = input.value.toUpperCase(); 
            const ul = document.getElementById('channel-list');
            const li = ul.getElementsByTagName('li');

            for (let i = 0; i < li.length; i++) {
                const txtValue = li[i].textContent || li