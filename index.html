<script>
        // إعداد مشغل HLS.js
        const video = document.getElementById('videoPlayer');
        const hls = new Hls();
        hls.attachMedia(video);

        // *** تم تحديث هذه الوظيفة ***
        // أضفنا "clickedElement" لتتبع القناة النشطة
        function playChannel(name, url, clickedElement) {
            document.getElementById('channel-title').innerText = `أنت تشاهد الآن: ${name}`;
            
            // --- كود جديد لتمييز القناة الفعالة ---
            // 1. إزالة التمييز (class 'active') من جميع القنوات
            const allChannels = document.querySelectorAll('#channel-list li');
            allChannels.forEach(item => {
                item.classList.remove('active');
            });
            // 2. إضافة التمييز (class 'active') للقناة التي تم النقر عليها
            if (clickedElement) {
                clickedElement.classList.add('active');
            }
            // --- نهاية الكود الجديد ---

            // تحميل وتشغيل البث الجديد
            hls.loadSource(url);
            hls.on(Hls.Events.MEDIA_ATTACHED, function () {
                video.play();
            });
            
            // (للهواتف) تمرير الشاشة للأعلى لرؤية المشغل
            window.scrollTo(0, 0);
        }

        // وظيفة لتحليل ملف m3u
        async function parseM3U(fileUrl) {
            try {
                const response = await fetch(fileUrl);
                const text = await response.text();
                const lines = text.split('\n');
                
                const channels = [];
                let currentTitle = null;

                for (const line of lines) {
                    if (line.startsWith('#EXTINF:')) {
                        const nameMatch = line.match(/tvg-name="([^"]+)"/);
                        if (nameMatch && nameMatch[1]) {
                            currentTitle = nameMatch[1];
                        } else {
                            currentTitle = line.split(',').pop();
                        }
                    } else if (line.startsWith('http') && currentTitle) {
                        channels.push({ name: currentTitle.trim(), url: line.trim() });
                        currentTitle = null; 
                    }
                }
                return channels;
            } catch (error) {
                console.error('خطأ في جلب ملف القنوات:', error);
                return [];
            }
        }

        // وظيفة لفلترة (بحث) القنوات (كما هي)
        function filterChannels() {
            const input = document.getElementById('search-bar');
            const filter = input.value.toUpperCase(); 
            const ul = document.getElementById('channel-list');
            const li = ul.getElementsByTagName('li');

            for (let i = 0; i < li.length; i++) {
                const txtValue = li[i].textContent || li[i].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    li[i].style.display = "";
                } else {
                    li[i].style.display = "none";
                }
            }
        }

        // عند تحميل الصفحة، ابدأ بكل شيء
        document.addEventListener('DOMContentLoaded', async () => {
            const channelListElement = document.getElementById('channel-list');
            const channels = await parseM3U('channels.m3u'); 

            if (channels.length > 0) {
                channelListElement.innerHTML = ''; 
                
                channels.forEach(channel => {
                    const li = document.createElement('li');
                    li.innerText = channel.name;
                    
                    // *** تم تحديث هذا السطر ***
                    // الآن نرسل "li" (العنصر نفسه) إلى وظيفة التشغيل
                    li.onclick = () => playChannel(channel.name, channel.url, li);
                    
                    channelListElement.appendChild(li);
                });
            } else {
                channelListElement.innerHTML = '<li class="loading error">فشل تحميل قائمة القنوات. تأكد من وجود ملف channels.m3u</li>';
            }
        });
    </script>